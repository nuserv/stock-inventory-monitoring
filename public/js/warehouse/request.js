var r=1,y=1,interval=null;
$(document).ready(function(){var a=new Date,g=String(a.getHours()).padStart(2,"0")%12||12,f=12>String(a.getHours()).padStart(2,"0")||24===String(a.getHours()).padStart(2,"0")?"AM":"PM",d="January February March April May June July August September October November December".split(" ");$("#date").val(d[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()+" "+g+":"+String(a.getMinutes()).padStart(2,"0")+f);$("#sdate").val(d[a.getMonth()]+" "+a.getDate()+", "+a.getFullYear()+" "+g+":"+String(a.getMinutes()).padStart(2,
"0")+f);var h=$("table.requestTable").DataTable({dom:"lrtip",language:{emptyTable:" "},processing:!0,serverSide:!0,ajax:"requests",columns:[{data:"created_at",name:"date",width:"14%"},{data:"request_no",name:"request_no",width:"14%"},{data:"reqBy",name:"reqBy",width:"14%"},{data:"branch",name:"branch",width:"14%"},{data:"area",name:"area",width:"14%"},{data:"status",name:"status",width:"14%"}]});interval=setInterval(function(){h.draw()},3E4);$("#requestTable tbody").on("click","tr",function(){clearInterval(interval);
var b=h.row(this).data();$("#requestTable tbody tr:eq(0)").data();if("SCHEDULED"==b.status){$("#prcBtn").hide();$(".sched").show();$("#printBtn").show();var c=new Date(b.sched);$("#sched").val(d[c.getMonth()]+" "+c.getDate()+", "+c.getFullYear())}else"PENDING"==b.status&&($("#prcBtn").show(),$(".sched").hide(),$("#sched").val(""),$("#printBtn").hide());$("#date").val(b.created_at);$("#reqno").val(b.request_no);$("#branch").val(b.branch);$("#name").val(b.reqBy);$("#area").val(b.area);$("#reqbranch").val(b.branch_id);
$("table.requestDetails").dataTable().fnDestroy();$("table.schedDetails").dataTable().fnDestroy();"PENDING"==b.status?($("#printBtn").hide(),$("table.schedDetails").hide(),$("table.requestDetails").show(),$("table.requestDetails").DataTable({dom:"lrtip",language:{emptyTable:" "},processing:!0,serverSide:!0,ajax:"/requests/"+b.request_no,columnDefs:[{className:"dt-body-center",targets:"_all"}],columns:[{data:"items_id",name:"items_id"},{data:"item_name",name:"item_name"},{data:"quantity",name:"quantity"},
{data:"purpose",name:"purpose"}]})):"SCHEDULED"==b.status&&($("#printBtn").show(),$("table.requestDetails").hide(),$("table.schedDetails").show(),$("table.schedDetails").DataTable({dom:"lrtip",language:{emptyTable:" "},processing:!0,serverSide:!0,ajax:"/send/"+b.request_no,columnDefs:[{className:"dt-center",targets:"_all"}],columns:[{data:"items_id",name:"items_id"},{data:"item_name",name:"item_name"},{data:"serial",name:"serial"}]}));$("#requestModal").modal("show")})});
$(document).on("click","#prcBtn",function(){$("#myid").val();$("#requestModal .closes").click();$("#sdate").val($("#date").val());$("#sreqno").val($("#reqno").val());$("#sbranch").val($("#branch").val());$("#sname").val($("#name").val());$("#sendModal").modal("show");for(var a=1;a<=y;a++)1!=a&&$("#row"+a).hide(),$("#stock"+a).css("border",""),$("#qty"+a).css("border",""),$("#category"+a).val("select category"),$("#item"+a).val("select item code"),$("#desc"+a).val("select description"),$("#qty"+a).val("Qty"),
$("#stock"+a).val("");$("table.sendDetails").dataTable().fnDestroy();$("table.sendDetails").DataTable({dom:"lrtip",language:{emptyTable:" "},processing:!0,serverSide:!0,ajax:"/requests/"+$("#sreqno").val(),columnDefs:[{className:"dt-body-center",targets:"_all"}],columns:[{data:"items_id",name:"items_id"},{data:"item_name",name:"item_name"},{data:"quantity",name:"quantity"},{data:"purpose",name:"purpose"}]})});
$(document).on("click",".add_item",function(){var a=$(this).attr("btn_id");if("Add Item"==$(this).val()){var g=0;if($("#category"+a).val()&&$("#item"+a).val()&&$("#desc"+a).val()&&$("#serial"+a).val()){var f=$("#item"+a).val();(function(b){$.ajax({type:"get",url:"getstock",async:!1,data:{id:f},success:function(c){if(""!=c){c=c[0].stock;for(var e=1;e<=y;e++)e!=a&&$("#item"+e).val()==$("#item"+a).val()&&($("#serial"+e).val()==$("#serial"+a).val()?($("#serial"+a).css("color","red"),$("#serial"+a).css("border",
"5px solid red"),g++):($("#serial"+a).css("color","black"),$("#serial"+a).css("border","")),$("#item"+e).prop("disabled")&&($("#stock"+e).val(c),c--));e==y&&($("#stock"+a).val(c),0>=c&&($("#stock"+a).css("color","red"),$("#stock"+a).css("border","5px solid red"),g++),$("#stock"+a).css("color","black"),$("#stock"+a).css("border",""))}}})})(stock1)}else return g++,!1;if(0==g){y++;var d='<div class="row no-margin" id="row'+y+'"><div class="col-md-2 form-group"><select id="category'+y+'" class="form-control category" row_count="'+
y+'"></select></div><div class="col-md-2 form-group"><select id="item'+y+'" class="form-control item" row_count="'+y+'"><option selected disabled>select item code</option></select></div><div class="col-md-3 form-group"><select id="desc'+y+'" class="form-control desc" row_count="'+y+'"><option selected disabled>select description</option></select></div><div class="col-md-2 form-group"><input type="text" class="form-control serial" row_count="'+y+'" name="serial1" id="serial'+y+'" placeholder="input serial"></div><div class="col-md-2 form-group"><input type="number" class="form-control" name="stock'+
y+'" id="stock'+y+'" placeholder="0" style="width: 6em" disabled></div><div class="col-md-1 form-group"><input type="button" class="add_item btn btn-xs btn-primary" btn_id="'+y+'" value="Add Item"></div></div>';$(this).val("Remove");$("#category"+a).prop("disabled",!0);$("#item"+a).prop("disabled",!0);$("#desc"+a).prop("disabled",!0);$("#serial"+a).prop("disabled",!0);20>r&&($("#reqfield").append(d),$("#category"+a).find("option").clone().appendTo("#category"+y),r++)}else return!1}else{20==r&&(y++,
d='<div class="row no-margin" id="row'+y+'"><div class="col-md-2 form-group"><select id="category'+y+'" class="form-control category" row_count="'+y+'"></select></div><div class="col-md-2 form-group"><select id="item'+y+'" class="form-control item" row_count="'+y+'"><option selected disabled>select item code</option></select></div><div class="col-md-3 form-group"><select id="desc'+y+'" class="form-control desc" row_count="'+y+'"><option selected disabled>select description</option></select></div><div class="col-md-2 form-group"><input type="text" class="form-control serial" row_count="'+
y+'" name="serial1" id="serial'+y+'" placeholder="input serial"></div><div class="col-md-2 form-group"><input type="number" class="form-control" name="stock'+y+'" id="stock'+y+'" placeholder="0" style="width: 6em" disabled></div><div class="col-md-1 form-group"><input type="button" class="add_item btn btn-xs btn-primary" btn_id="'+y+'" value="Add Item"></div></div>',$("#reqfield").append(d),$("#category"+a).find("option").clone().appendTo("#category"+y),r++);f=$("#item"+a).val();var h=0;$("#category"+
a).val("select category");$("#item"+a).val("select item code");$("#desc"+a).val("select description");$("#serial"+a).val("select serial");$("#category"+a).prop("disabled",!1);$("#item"+a).prop("disabled",!1);$("#desc"+a).prop("disabled",!1);$("#serial"+a).prop("disabled",!1);$("#row"+a).hide();$(this).val("Add Item");(function(b){$.ajax({type:"get",url:"getstock",data:{id:f},async:!1,success:function(c){if(""!=c)for(var e=1;e<=y;e++)e!=a&&$("#item"+e).val()==f&&($("#stock"+e).val(c[0].stock-h),h++)}})})(stock1);
r--}});
$(document).on("click",".sub_Btn",function(a){a.preventDefault();var g=$("#sreqno").val(),f=1;if($("#datesched").val())for(var d=1;d<=y;d++)$("#row"+d).is(":visible")&&"Remove"==$(".add_item[btn_id='"+d+"']").val()&&(f++,$("#category"+d).val(),a=$("#item"+d).val(),$("#desc"+d).val(),serial=$("#serial"+d).val(),datesched=$("#datesched").val(),branchid=$("#reqbranch").val(),$.ajax({url:"update",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},dataType:"json",type:"PUT",data:{item:a,serial:serial,
reqno:g,branchid:branchid}})),d==y&&1<f&&($.ajax({url:"update",headers:{"X-CSRF-TOKEN":$('meta[name="csrf-token"]').attr("content")},type:"PUT",data:{reqno:g,datesched:datesched,stat:"ok",status:"1"},dataType:"json"}),alert("Branch request updated!!!!"),window.location.href="/print/"+g);else alert("Please select schedule date!!!")});
$(document).on("change",".desc",function(){var a=$(this).attr("row_count"),g=$(this).val(),f=0,d=" ";$("#item"+a).val(g);for(var h=1;h<=y;h++)h!=a&&$("#desc"+h).val()==$(this).val()&&f++;(function(b){$.ajax({type:"get",url:"getstock",data:{id:g},async:!1,success:function(c){""!=c?($("#stock"+a).val(c[0].stock-f),$("#stock"+a).css("color","black"),$("#stock"+a).css("border",""),0>=$("#stock"+a).val()&&($("#stock"+a).css("color","red"),$("#stock"+a).css("border","5px solid red"))):($("#stock"+a).val("0"),
$("#stock"+a).css("color","red"),$("#stock"+a).css("border","5px solid red"))}});$.ajax({type:"get",url:"getserials",data:{id:g},async:!1,success:function(c){d+='<option selected value="select" disabled>select serial</option>';for(var e=0;e<c.length;e++)d+='<option value="'+c[e].serial+'">'+c[e].serial+"</option>";$("#serial"+a).find("option").remove().end().append(d)}})})(stock1);for(h=1;h<=y;h++)$("#desc"+h).val()==$(this).val()&&(rmserial=$("#serial"+h).val(),$("#serial"+a+" option[value='"+rmserial+
"']").remove())});
$(document).on("change",".item",function(){var a=$(this).attr("row_count"),g=$(this).val(),f=0,d=" ",h="";$("#desc"+a).val(g);for(var b=1;b<=y;b++)b!=a&&$("#item"+b).val()==$(this).val()&&f++;(function(c){$.ajax({type:"get",url:"getstock",data:{id:g},async:!1,success:function(e){if(""!=e){if($("#stock"+a).val(e[0].stock-f),$("#stock"+a).css("color","black"),$("#stock"+a).css("border",""),0>$("#stock"+a).val()||0==$("#stock"+a).val())$("#stock"+a).css("color","red"),$("#stock"+a).css("border","5px solid red")}else $("#stock"+
a).val("0"),$("#stock"+a).css("color","red"),$("#stock"+a).css("border","5px solid red")}});$.ajax({type:"get",url:"getserials",data:{id:g},async:!1,success:function(e){d+='<option selected value="select" disabled>select serial</option>';for(var k=0;k<e.length;k++)d+='<option value="'+e[k].serial+'">'+e[k].serial+"</option>";$("#serial"+a).find("option").remove().end().append(d)}})})(stock1);for(b=1;b<=y;b++)$("#item"+b).val()==$(this).val()&&(h=$("#serial"+b).val(),$("#serial"+a+" option[value='"+
h+"']").remove())});
$(document).on("change",".category",function(){var a=" ",g=" ",f=$(this).attr("row_count"),d=$(this).val();$("#stock"+f).val("0");(function(h){$.ajax({type:"get",url:"itemcode",data:{id:d},success:function(b){a+='<option selected value="select" disabled>select item code</option>';g+='<option selected value="select" disabled>select description</option>';for(var c=0;c<b.length;c++)a+='<option value="'+b[c].id+'">'+b[c].id+"</option>",g+='<option value="'+b[c].id+'">'+b[c].item.toUpperCase()+"</option>";
$("#item"+f).find("option").remove().end().append(a);$("#desc"+f).find("option").remove().end().append(g)}})})(item1);$("#item"+f).val("select itemcode");$("#desc"+f).val("select description");$("#stock"+f).css("border","");$("#item"+f).css("border","")});$(document).on("click",".cancel",function(){window.location.href="request"});$(document).on("click","#printBtn",function(){window.location.href="/print/"+$("#reqno").val()});